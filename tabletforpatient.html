<!-- new tablet in loop rate start -->

{% load static %}
<head>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Select2 CSS & JS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<!-- <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" /> -->

<!-- Bootstrap 5 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap 5 JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>


  <meta charset="UTF-8">
  <title>Tablet Rate Finder</title>
  <style>

    @media print {
  body * { visibility: hidden; }
  #printArea, #printArea * { visibility: visible; }
  #printArea { position: absolute; left: 0; top: 0; width: 100%; }
  .modal-header, .modal-footer { display: none !important; }
}

  </style>

  <script>

    </script>
</head>
<!-- new tablet in loop rate end -->

<body>

{{earliertablet_list}}

<div class="container-fluid">

    <h1 class="text-center">Tablet Counter</h1>

    <div class="text-center">
        {% for j in single_patientdetail_for_tablet %}
            <h4><b>Name:</b> {{ j.patientname|capfirst }}</h4>
            <h4><b>ID:</b> {{ j.patientid }}</h4>
        {% endfor %}
    </div>

    
   

    <!-- RESPONSIVE WRAPPER -->
    <div class="table-responsive">
        <a href="{% url 'home' %}" class=" text-primary text-decoration-underline fs-5"><u>Tablet Stock Add</u>/</a>
        <a href="{% url 'tabletlist' %}" class="fs-5"><u>Tablet Stock List</u>/</a>
        <a href="{% url 'masterpatientlist' %}" class="fs-5"><u>Master Patient List</u></a>
        <button id="addNewBtn" class="btn btn-success btn-md pull-right mb-3">ADD</button>
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

        <table id="medicineTable" class="table table-bordered table-sm align-middle mt-3">

            <thead class="table-light">
                <tr>
                    <th>Tablet ID</th>
                    <th>Expiry</th>
                    <th>Brand *</th>
                    <th>Combination *</th>
                    <th>Category *</th>
                    <th>Qty</th>
                    <th>GST(%)</th>
                    <th>Days</th>
                    <th>Food</th>
                    <th>Morn</th>
                    <th>Noon</th>
                    <th>Night</th>
                    <th>MRP ‚Çπ</th>
                    <th>Total</th>
                    <th>GST(‚Çπ)</th>
                    <th>CGST</th>
                    <th>SGST</th>
                </tr>
            </thead>

            <tbody id="tabletforpatientnewrowadd">

                <tr>

                    <td><input type="text" class="form-control form-control-sm tabletid  bg-success text-white" readonly></td>

                    <td>
                    <input type="text" class="form-control form-control-sm expiry bg-success text-white" readonly>
                    </td>

                    <td class="d-none">
                        <input type="hidden" class="tabletid" name="tabletid[]">
                    </td>

                    
                    </td>

                    <td>
                        <input list="brandlist" class="form-control input-sm tabletname" placeholder="Select Brand">
                        <datalist id="brandlist">
                            {% for tablet in tablet_list %}
                            <option value="{{tablet.tabletname}}">
                            {% endfor %}
                        </datalist>
                     </td>

                        <td>
                            <input list="combinationlist" class="form-control input-sm combinationname" placeholder="Select Combination">
                            <datalist id="combinationlist">
                                {% for combination in combination_list %}
                                <option value="{{combination.combinationname}}">
                                {% endfor %}
                            </datalist>
                        </td>


                  
                    <td>
                        <input list="categorylist" class="form-control input-sm category_name" placeholder="Select Category">
                        <datalist id="categorylist">
                            {% for category in category_list %}
                            <option value="{{category.categoryname}}">
                            {% endfor %}
                        </datalist>
                    </td>



                    <!-- INPUTS -->
                    <td><input type="number" class="form-control form-control-sm qty"></td>
                    <td><input type="number" class="form-control form-control-sm gst"></td>
                    <td><input type="number" min="1" class="form-control form-control-sm days"></td>

                    <!-- FOOD -->
                                <td>
                    <input list="foodList" class="form-control input-sm food_type" placeholder="Select Food Type">
                    <datalist id="foodList">
                        <option value="before">
                        <option value="after">
                    </datalist>
                </td>

                    <!-- COUNTS -->
                    <td><input type="number" min="0" class="form-control form-control-sm morning"></td>
                    <td><input type="number" min="0" class="form-control form-control-sm afternoon"></td>
                    <td><input type="number" min="0" class="form-control form-control-sm night"></td>

                    <!-- MRP -->
                    <td><input type="text" class="form-control form-control-sm pertabletmrp bg-success text-white" readonly></td>

                    <!-- TOTAL -->
                    <td><input type="number" class="form-control form-control-sm total bg-success text-white" readonly></td>

                    <!-- GST VALUES -->
                    <td><input type="text" class="form-control form-control-sm total_gst bg-success text-white" readonly></td>
                    <td class="cgst text-center bg-success text-white">0.00</td>
                    <td class="sgst text-center bg-success text-white">0.00</td>
                    <td><button type="button" class="btn btn-danger btnRemove">X</button></td>
                    

                </tr>

            </tbody>

        </table>
    </div>
</div>

  <h4 class="text-center">Overall Tablet Total:  <input type="number" class="bg-success text-white" id="overalltablettotal" readonly><br></h4>
    <div id="tableError" style="display:none;"></div>
<div class="container mt-4">

    <div class="row g-3">

        <!-- CARD 1 : TAX / SCAN / DISCOUNT -->
        <div class="col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-info text-white">
                    Tax & Charges
                </div>

                <div class="card-body">
                    <div class="row g-2">

                        <div class="col-12">
                            <label class="form-label">Sales Tax (%)</label>
                            <input type="number" id="salestax_percent"
                                   class="form-control form-control-sm"
                                   step="0.01">
                        </div>

                        <div class="col-12">
                            <label class="form-label">Service Charge (‚Çπ)</label>
                            <input type="number" id="service_charge"
                                   class="form-control form-control-sm" value="0">
                        </div>

                        <div class="col-12">
                            <label class="form-label">Delivery Charge (‚Çπ)</label>
                            <input type="number" id="delivery_charge"
                                   class="form-control form-control-sm" value="0">
                        </div>

                        <div class="col-12">
                            <label class="form-label">Scan Charge (‚Çπ)</label>
                            <input type="number" id="scan_charge"
                                   class="form-control form-control-sm" value="0">
                        </div>

                        <div class="col-12">
                            <label class="form-label">Net Amount (‚Çπ)</label>
                            <input type="text" id="net_amount"
                                   class="form-control form-control-sm bg-success text-white"
                                   readonly>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- CARD 2 : PAYMENT -->
        <div class="col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-success text-white">
                    Payment
                </div>

                <div class="card-body">

                    <div class="mb-2">
                        <label class="form-label">Cash Paid (‚Çπ)</label>
                        <input type="number" id="cash_paid"
                               class="form-control form-control-sm">
                    </div>

                    <div class="mb-2">
                        <label class="form-label">GPay / UPI Paid (‚Çπ)</label>
                        <input type="number" id="gpay_paid"
                               class="form-control form-control-sm">
                    </div>

                    <div>
                        <label class="form-label">Remaining Amount (‚Çπ)</label>
                        <input type="number" id="remaining_amount"
                               class="form-control form-control-sm bg-success text-white"
                               readonly>
                    </div>
                    <div class="row" style="margin-top: 50px";>
                        <div class="text-end">
                           <button id="myBtn">Click me</button>
                        </div>
                    </div>


                </div>
            </div>
        </div>

        <!-- CARD 3 : GST SUMMARY -->
        <div class="col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-warning text-dark">
                    GST Summary
                </div>

                <div class="card-body">

                    <div class="mb-2">
                        <label>Overall GST (‚Çπ)</label>
                        <input type="text" id="overall_gst"
                               class="form-control form-control-sm bg-success text-white"
                               readonly>
                    </div>

                    <div class="mb-2">
                        <label>Overall CGST (‚Çπ)</label>
                        <input type="text" id="overall_cgst"
                               class="form-control form-control-sm bg-success text-white"
                               readonly>
                    </div>

                    <div>
                        <label>Overall SGST (‚Çπ)</label>
                        <input type="text" id="overall_sgst"
                               class="form-control form-control-sm bg-success text-white"
                               readonly>
                    </div>

                </div>
            </div>
        </div>

    </div>
</div>

   
</div>

<!-- bill start -->
 <!-- BILL MODAL -->
<!-- BILL MODAL -->
<div class="modal fade" id="billModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content shadow-lg border-0">

      <!-- HEADER -->
      <div class="modal-header bg-primary text-white">
        <!-- <h5 class="modal-title fw-bold">üßæ Medical Invoice</h5> -->
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <!-- BODY -->
      <div class="modal-body bg-light" id="printArea">
          <!-- <div class="col-2 text-center">
            <img src="{% static 'img/maternity.jpg' %}" style="max-height:70px;">
           </div> -->
        <!-- Hospital Info -->
         
        <div class="text-center mb-3">
          <h3 class="fw-bold text-primary mb-0">Sana Hospital</h3>
          <h6 class="text-muted">
                Opposite Asian school, Sivagangai Main Road<br>
                Melur, Madurai - 625106<br>
                Tamil Nadu.
                </h6>
        </div>
          {% for j in single_patientdetail_for_tablet %}
        <div class="row mb-2">
            <div class="col">
                <b>Patient Name:</b> <p class="patientname"><b>{{ j.patientname|capfirst }}</b></p>
                
            </div>
            <div class="col">            
                <b>Patient Id:</b> <p class="patientid"><b>{{ j.patientid }}</b></p>

                </div>

            <div class="col text-end">
                <b>Date:</b> <span id="billDate"></span>
            </div>
        </div>
               {% endfor %}

        <!-- TABLE -->
        <div class="table-responsive">
          <table class="table table-bordered table-sm align-middle text-center">
            <thead class="table-dark">
              <tr>
                <th>S.No</th>
                <th>Category</th>
                <th>Days</th>
                <th>M</th>
                <th>A</th>
                <th>N</th>
                <th>Qty</th>
                <th>MRP</th>
                <th id="gstHead">GST</th>
                <th id="cgstHead">CGST</th>
                <th id="sgstHead">SGST</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody id="billBody"></tbody>
          </table>
        </div>

        <!-- TOTAL SECTION -->
        <div class="card border-0 shadow-sm mt-3">
          <div class="card-body p-3">

            <div class="row text-center fw-semibold">
              <div class="col border-end">
                Tablet Total<br>
                <span class="text-primary fs-5">‚Çπ <span id="billTabletTotal"></span></span>
              </div>
              <div class="col d-none" id="rowSalesTax">Sales Tax<br>‚Çπ <span id="billSalesTax"></span></div>
              <div class="col d-none" id="rowService">Service<br>‚Çπ <span id="billService"></span></div>
              <div class="col d-none" id="rowDelivery">Delivery<br>‚Çπ <span id="billDelivery"></span></div>
              <div class="col d-none" id="rowScan">Scan<br>‚Çπ <span id="billScan"></span></div>
            </div>

            <!-- OVERALL GST -->
            <div class="row text-center fw-bold text-danger mt-3 d-none" id="overallGstRow">
              <div class="col">Overall GST<br>‚Çπ <span id="billOverallGST">0.00</span></div>
              <div class="col">Overall CGST<br>‚Çπ <span id="billOverallCGST">0.00</span></div>
              <div class="col">Overall SGST<br>‚Çπ <span id="billOverallSGST">0.00</span></div>
            </div>

            <hr>

            <h4 class="text-center text-success fw-bold">
              NET AMOUNT: ‚Çπ <span id="billNet"></span>
            </h4>

            <div class="row text-center mt-2">
              <div class="col d-none" id="rowCash">Cash ‚Çπ <span id="billCash"></span></div>
              <div class="col d-none" id="rowUpi">UPI ‚Çπ <span id="billUpi"></span></div>
              <div class="col d-none" id="rowRemain">Remaining ‚Çπ <span id="billRemain"></span></div>
            </div>

          </div>
        </div>

      </div>

      <!-- FOOTER -->
      <div class="modal-footer bg-white">
        <button class="btn btn-success px-4" id="printBillBtn">üñ® Print</button>
      </div>

    </div>
  </div>
</div>


<!-- bill end -->

</body>

  <script>
    $(document).on("click", "#addNewBtn", function () {

    $.ajax({
        url: "/add_newtablet_btn/",  // Django URL path
        type: "POST",
        data: {
            action: "new",
            csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val()
        },
        success: function (data) {
            // alert("Data inserted successfully!");

            let lastRow = $("#medicineTable tr:last");

            let t = lastRow.find(".tabletname").val();
            let c = lastRow.find(".combinationname").val();
            let g = lastRow.find(".category_name").val();
            let qty = lastRow.find(".qty").val();

            // If any field missing ‚Üí show error + block add row
            if (!t || !c || !g || !qty) {
                $("#tableError")
                    .html("<p style='color:red;font-weight:bold;padding:6px;'>‚ö† Please select Tablet, Combination & Category & Quantity before adding new row!</p>")
                    .css({
                        "background": "#ffe6e6",
                        "border": "1px solid red",
                        "margin-top": "6px"
                    })
                    .show();
                return; // stop row adding
            }
            //error start
             
            //error end

            let tablets = data.tablet_list;
            let combinations = data.combination_list;
            let category = data.category_list;

            // Example: Append new row using response data
        
         let newRow = `
                <tr data-id="">

                    <td><input type="text" class="form-control form-control-sm tabletid bg-success text-white" readonly></td>

                    <td>
                    <input type="text" class="form-control form-control-sm expiry bg-success text-white" readonly>
                    </td>

                    <td>
                        <input list="brandlist" class="form-control input-sm tabletname" placeholder="Select Brand">
                        <datalist id="brandlist">
                            {% for tablet in tablet_list %}
                            <option value="{{tablet.tabletname}}">
                            {% endfor %}
                        </datalist>
                     </td>

                     <td>
                            <input list="combinationlist" class="form-control input-sm combinationname" placeholder="Select Combination">
                            <datalist id="combinationlist">
                                {% for combination in combination_list %}
                                <option value="{{combination.combinationname}}">
                                {% endfor %}
                            </datalist>
                        </td>
                       <td>
                        <input list="categorylist" class="form-control input-sm category_name" placeholder="Select Category">
                        <datalist id="categorylist">
                            {% for category in category_list %}
                            <option value="{{category.categoryname}}">
                            {% endfor %}
                        </datalist>
                    </td>
                    
                    <td><input type="number" class="form-control form-control-sm qty"></td>
                    <td><input type="number" class="form-control form-control-sm gst"></td>
                    <td><input type="number" min="1" class="form-control form-control-sm days"></td>

                    <!-- FOOD -->
                         <td>
                    <input list="foodList" class="form-control input-sm food_type" placeholder="Select Food Type">
                    <datalist id="foodList">
                        <option value="before">
                        <option value="after">
                    </datalist>
                </td>


                    <!-- COUNTS -->
                    <td><input type="number" min="0" class="form-control form-control-sm morning"></td>
                    <td><input type="number" min="0" class="form-control form-control-sm afternoon"></td>
                    <td><input type="number" min="0" class="form-control form-control-sm night"></td>

                    <!-- MRP -->
                    <td><input type="text" class="form-control form-control-sm pertabletmrp bg-success text-white" readonly></td>

                    <!-- TOTAL -->
                    <td><input type="number" class="form-control form-control-sm total bg-success text-white" readonly></td>

                    <!-- GST VALUES -->
                    <td><input type="text" id="total_gst" class="form-control form-control-sm total_gst bg-success text-white" readonly></td>
                    <td class="cgst text-center bg-success text-white">0.00</td>
                    <td class="sgst text-center bg-success text-white">0.00</td>
                    // <td><button type="button" class="btn btn-danger btnRemove">X</button></td>
                    </tr>
            `;

            $("#tabletforpatientnewrowadd").append(newRow);
             $("#tableError").hide();

              // $("#medicineTable tbody").append(row);

            let addedRow = $("#medicineTable tr:last");

            // Add tablet list
           tablets.forEach(function(item) {
                addedRow.find(".tabletname").append(`
                    <option>${item.tabletname}</option>
                `);
            });

            // Add combination list
            combinations.forEach(function(item) {
                addedRow.find(".combinationname").append(`
                    <option>${item.combinationname}</option>
                `);
            });

            category.forEach(function(item) {
                addedRow.find(".category_name").append(`
                    <option>${item.categoryname}</option>
                `);
            });


        },
        error: function () {
            alert("Failed to insert!");
        }
    });
});

  </script>


  {{ earliertablet_list|json_script:"mydata" }}
  

  <script>

    let medicines = JSON.parse(document.getElementById("mydata").textContent);




    function isDuplicateMedicine(row) {

    let t = row.find(".tabletname").val();
    let c = row.find(".combinationname").val();
    let g = row.find(".category_name").val();

    let isDuplicate = false;

    $("#medicineTable tbody tr").each(function () {

        // ‚ùó ignore fifo rows
        if ($(this).hasClass("fifo-row")) return;

        // ‚ùó ignore same row
        if (this === row[0]) return;

        let t2 = $(this).find(".tabletname").val();
        let c2 = $(this).find(".combinationname").val();
        let g2 = $(this).find(".category_name").val();

        if (t && c && g && t === t2 && c === c2 && g === g2) {
            isDuplicate = true;
            return false; // break loop
        }
    });

    return isDuplicate;
}


function applyFIFO(row, qtyNeeded) {

    clearFifoRows();

    let t = row.find(".tabletname").val();
    let c = row.find(".combinationname").val();
    let g = row.find(".category_name").val();

    if (!t || !c || !g || qtyNeeded <= 0) return;

    // 1Ô∏è‚É£ Get matching batches
    let batches = medicines
        .filter(m =>
            m.tabletname === t &&
            m.combinationname === c &&
            m.category_name === g &&
            parseFloat(m.tabletqty) > 0
        )
        .sort((a, b) => new Date(a.expireddate) - new Date(b.expireddate)); // FIFO

    if (!batches.length) {
        $("#tableError").html("‚ùå No stock available").show();
        return;
    }

    let totalAvailable = batches.reduce((s, b) => s + parseFloat(b.tabletqty), 0);

    if (qtyNeeded > totalAvailable) {
        $("#tableError").html(`‚ùå Only ${totalAvailable} qty available`).show();
        row.find(".qty").val("");
        return;
    }

    $("#tableError").hide();

    // üî• Remove previously auto-added FIFO rows
    // row.nextAll(".fifo-row").remove();

    let remaining = qtyNeeded;
    let currentRow = row;

    for (let batch of batches) {

        if (remaining <= 0) break;

        let take = Math.min(remaining, batch.tabletqty);

        currentRow.find(".tabletid").val(batch.tabletid);
        currentRow.find(".pertabletmrp").val(batch.pertabletmrp);
        currentRow.find(".qty").val(take);
        currentRow.find(".expiry").val(batch.expireddate);
        currentRow.find(".total").val((take * batch.pertabletmrp).toFixed(2));

        remaining -= take;

        // 2Ô∏è‚É£ Need next expiry ‚Üí create new row
        if (remaining > 0) {

            let newRow = $("#medicineTable tbody tr:first").clone();
            newRow.addClass("fifo-row");

            newRow.find("input").val("");
            newRow.find(".cgst,.sgst").text("0.00");

            $("#tabletforpatientnewrowadd").append(newRow);

            newRow.find(".tabletname").val(t).prop("disabled", true);
            newRow.find(".combinationname").val(c).prop("disabled", true);
            newRow.find(".category_name").val(g).prop("disabled", true);

            newRow.find(".qty")
            .prop("readonly", true)
            .addClass("bg-light");

            currentRow = newRow;
        }
    }

    calculateGrandTotal();
}

function clearFifoRows() {
    // $("#medicineTable tbody .fifo-row").remove();
}


$(document).on("change", ".tabletname, .combinationname, .category_name", function () {

    let row = $(this).closest("tr");

    let t = row.find(".tabletname").val();
    let c = row.find(".combinationname").val();
    let g = row.find(".category_name").val();

    // reset fields
    row.find(".tabletid,.expiry,.pertabletmrp,.qty,.total").val("");

    if (!t || !c || !g) return;

    // ‚ùå DUPLICATE CHECK
    if (isDuplicateMedicine(row)) {

        $("#tableError")
            .html("‚ùå This Tablet + Combination + Category is already selected. Please choose another.")
            .show();

        // clear only selection, NOT whole row
        row.find(".tabletname,.combinationname,.category_name").val("");
        return;
    }

    $("#tableError").hide();

    // ‚úÖ FIFO should work normally
    applyFIFO(row, 1);
});




</script>



<script>
function parseNumber(v) {
    if (v === undefined || v === null) return 0;
    // allow commas like "1,234.56"
    v = String(v).trim().replace(/,/g, "");
    return isNaN(parseFloat(v)) ? 0 : parseFloat(v);
}

//  gst
$(document).on("keyup change", ".pertabletmrp, .qty, .gst", function () {

    let row = $(this).closest("tr");

    let rate = parseFloat(row.find(".pertabletmrp").val()) || 0;
    let qty = parseFloat(row.find(".qty").val()) || 0;
    let gst = parseFloat(row.find(".gst").val()) || 0;

    let total = rate * qty;
    row.find(".total").val(total.toFixed(2)); // üî• ensure total updates

    // GST portion extraction
    let gstAmount = total * (gst / (100 + gst));
    let cgst = gstAmount / 2;
    let sgst = gstAmount / 2;

    row.find(".total_gst").val(gstAmount.toFixed(2));
    row.find(".cgst").text(cgst.toFixed(2));
    row.find(".sgst").text(sgst.toFixed(2));

    row.data("gstAmount", gstAmount);

    calculateOverallGST();
    calculateGrandTotal(); // üî• update totals
});

function calculateOverallGST() {

    let overallGST = 0;

    $("#medicineTable tbody tr").each(function () {
        let rowGST = $(this).data("gstAmount") || 0;
        overallGST += rowGST;
    });

    let overallCGST = overallGST / 2;
    let overallSGST = overallGST / 2;

    $("#overall_gst").val(overallGST.toFixed(2));
    $("#overall_cgst").val(overallCGST.toFixed(2));
    $("#overall_sgst").val(overallSGST.toFixed(2));
}




function calculateGrandTotal() {
    let grand = 0;

    $(".total").each(function () {
        grand += parseFloat($(this).val()) || 0;
    });

    $("#overalltablettotal").val(grand.toFixed(2));
    // sales tax
        let taxPercent = parseFloat($("#salestax_percent").val()) || 0; // if blank, treat as 0

        let serviceCharge = parseFloat($("#service_charge").val()) || 0;
        let deliveryCharge = parseFloat($("#delivery_charge").val()) || 0;
        let scanAmount = parseFloat($("#scan_charge").val()) || 0;

        let taxAmount = 0;
        if(taxPercent > 0) {
            taxAmount = (grand * taxPercent) / 100;
        }

        let net = grand + taxAmount + serviceCharge + deliveryCharge + scanAmount ;

    $("#net_amount").val(net.toFixed(2));


       calculateBalance();
}

$(document).on("input", "#salestax_percent , #service_charge, #delivery_charge, #scan_charge", calculateGrandTotal);

// $(document).on("input", " , function () {
//     calculateBalance();
// });
    </script>

    <script>
// error

// Event for static and appended rows
$(document).on("change", ".tabletname, .combinationname, .category_name", function () {
    let row = $(this).closest("tr");

    let t = row.find(".tabletname").val();
    let c = row.find(".combinationname").val();
    let g = row.find(".category_name").val();
    let rateInput = row.find(".pertabletmrp");

    $("#tableError").hide().html(""); // clear error

    if (t === "" || c === "" || g === "") {
        rateInput.val(0);
        return;
    }

    let key = `${t}|${c}|${g}`;


    let found = medicines.find(x => x.tabletname === t && x.combinationname === c && x.category_name === g);

    if (found) {
        rateInput.val(found.pertabletmrp);
    } else {
        rateInput.val(0);
        $("#tableError")
            .html("<p style='color:red;font-weight:bold;padding:6px;'>‚ö† Selected Combination Not Found!</p>")
            .css({
                "background": "#ffe6e6",
                "border": "1px solid red",
                "margin-top": "6px"
            })
            .show();
    }
    });

    // ---------- üîç Duplicate Check Across Rows ----------
    // let duplicate = false;
    // $(".tabletname").each(function () {
    //     let r = $(this).closest("tr");
    //     let tt = r.find(".tabletname").val();
    //     let cc = r.find(".combinationname").val();
    //     let gg = r.find(".category_name").val();
    //     if (tt && cc && gg) {
    //         if (`${tt}|${cc}|${gg}` === key && r.index() !== row.index()) {
    //             duplicate = true;
    //         }
    //     }
    // });

    // if (duplicate) {
    //     rateInput.val(0);
    //     $("#tableError")
    //         .html("<p style='color:red;font-weight:bold;padding:6px;'>‚ö† This Combination Already Added in Table!</p>")
    //         .css({
    //             "background": "#ffe6e6",
    //             "border": "1px solid red",
    //             "margin-top": "6px"
    //         })
    //         .show();
    //     return;
    // }


    // ---------- üîç Find Rate from JSON ----------






$(document).on("click", ".btnRemove", function () {
    $(this).closest("tr").remove();
      $("#tableError").hide();
      calculateGrandTotal();   
    calculateOverallGST();
});

setTimeout(() => { $("#tableError").fadeOut(); }, 3000);



      </script>
<script>


$(document).on("input", ".qty", function () {
    let row = $(this).closest("tr");
    let qty = parseFloat($(this).val()) || 0;

    row.nextAll(".fifo-row").remove();
    applyFIFO(row, qty);
});

</script>


<script>

function calculateBalance() {
    let total = parseFloat($("#net_amount").val()) || 0;
    let cash = parseFloat($("#cash_paid").val()) || 0;
    let gpay = parseFloat($("#gpay_paid").val()) || 0;

    let paid = cash + gpay;
    let remain = total - paid;

    $("#remaining_amount").val(remain.toFixed(2));
}

// When changing payment
$(document).on("input", "#cash_paid, #gpay_paid", calculateBalance);

// üü¢ When adding items and Grand Total updated
function updateGrandTotal(new_total) {
    $("#total_amount").val(new_total);
    calculateBalance();  // auto recalculate remaining
}

</script>

<script>
 document.getElementById("myBtn").addEventListener("click", function () {

    let tableData = [];
    let hasError = false;

    $("#medicineTable tbody tr").each(function () {

        let tabletname = ($(this).find(".tabletname").val() || "").trim();
        let combinationname = ($(this).find(".combinationname").val() || "").trim();
        let categoryname = ($(this).find(".category_name").val() || "").trim();

        // Remove old errors
        $(this).removeClass("row-error");
        $(this).find(".error-msg").remove();

        // Validation
        if (!tabletname || !combinationname || !categoryname) {

            hasError = true;
            $(this).addClass("row-error");

            let message = "Required: ";
            if (!tabletname) message += "Brand Name, ";
            if (!combinationname) message += "Combination, ";
            if (!categoryname) message += "Category, ";
            message = message.replace(/, $/, "");

            $(this).append("<td class='error-msg' style='color:red'>" + message + "</td>");
            return; // skip this row
        }

        // Collect row data
        tableData.push({
            tabletid: $(this).find(".tabletid").val(),
            expiry: $(this).find(".expiry").val(),
            tabletname: tabletname,
            combinationname: combinationname,
            category_name: categoryname,
            qty: $(this).find(".qty").val(),
            gst: $(this).find(".gst").val(),
            days: $(this).find(".days").val(),
            food_type: $(this).find(".food_type").val(),
            morning: $(this).find(".morning").val(),
            afternoon: $(this).find(".afternoon").val(),
            night: $(this).find(".night").val(),
            pertabletmrp: $(this).find(".pertabletmrp").val(),
            total: $(this).find(".total").val(),
            total_gst: $(this).find(".total_gst").val(),
            cgst: $(this).find(".cgst").text(),
            sgst: $(this).find(".sgst").text()
        });

    }); // END LOOP

    // Stop if any row invalid
    if (hasError) {
        alert("Some rows have missing fields");
        return;
    }

    // Get other values OUTSIDE loop
    var salestax_percent = $('#salestax_percent').val();
    var service_charge = $('#service_charge').val();
    var delivery_charge = $('#delivery_charge').val();
    var scan_charge = $('#scan_charge').val();
    var net_amount = $('#net_amount').val();
    var cash_paid = $('#cash_paid').val();
    var gpay_paid = $('#gpay_paid').val();
    var remaining_amount = $('#remaining_amount').val();
    var overall_gst = $('#overall_gst').val();
    var overall_cgst = $('#overall_cgst').val();
    var overall_sgst = $('#overall_sgst').val();
    var patientname = $(".patientname").text();
    var patientid = $(".patientid").text();

    console.log("Sending:", tableData);

    $.ajax({
        url: "/patienttabletdistribute/",
        type: "POST",
        data: {
            tabletdetail: JSON.stringify(tableData),
            salestax_percent: salestax_percent,
            service_charge: service_charge,
            delivery_charge: delivery_charge,
            scan_charge: scan_charge,
            net_amount: net_amount,
            cash_paid: cash_paid,
            gpay_paid: gpay_paid,
            remaining_amount: remaining_amount,
            overall_gst: overall_gst,
            overall_cgst: overall_cgst,
            overall_sgst: overall_sgst,
            patientname : patientname,
            patientid : patientid

        },
        success: function (res) {
            alert("Saved successfully");
        },
        error: function () {
            alert("Error saving data");
            alert("AJAX Success Triggered");   // üëà test
            generateBill();
            var myModal = new bootstrap.Modal(document.getElementById('billModal'));
            myModal.show();
         
            
        }
    });

});

</script>

<script>
var billModal = new bootstrap.Modal(document.getElementById('billModal'));

document.getElementById('billModal').addEventListener('hidden.bs.modal', function () {
    document.body.classList.remove('modal-open');
    document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
});
function generateBill() {

    let gstUsed = false;
    let i = 1;
    let billRows = "";
    let tabletTotal = 0;

    let d = new Date();
    let months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    $("#billDate").text(d.getDate() + " " + months[d.getMonth()] + " " + d.getFullYear());

    $("#medicineTable tbody tr").each(function () {

        let category = $(this).find(".combinationname").val();
        if (!category) return;

        let days = $(this).find(".days").val() || "-";
        let morning = $(this).find(".morning").val() || "-";
        let afternoon = $(this).find(".afternoon").val() || "-";
        let night = $(this).find(".night").val() || "-";
        let qty = $(this).find(".qty").val();
        let mrp = $(this).find(".pertabletmrp").val();

        let gst = parseFloat($(this).find(".total_gst").val()) || 0;
        let cgst = parseFloat($(this).find(".cgst").text()) || 0;
        let sgst = parseFloat($(this).find(".sgst").text()) || 0;
        let total = parseFloat($(this).find(".total").val()) || 0;

        // üî• OVERALL GST SHOW IN BILL
        let overallGST  = parseFloat($("#overall_gst").val()) || 0;
        let overallCGST = parseFloat($("#overall_cgst").val()) || 0;
        let overallSGST = parseFloat($("#overall_sgst").val()) || 0;

        if (overallGST > 0) {
            $("#billOverallGST").text(overallGST.toFixed(2));
            $("#billOverallCGST").text(overallCGST.toFixed(2));
            $("#billOverallSGST").text(overallSGST.toFixed(2));

            $("#overallGstRow").removeClass("d-none"); // SHOW
        } else {
            $("#overallGstRow").addClass("d-none"); // HIDE
        }

        if (gst > 0) gstUsed = true;
        tabletTotal += total;

        billRows += `
        <tr>
          <td>${i++}</td>
          <td>${category}</td>
          <td>${days}</td>
          <td>${morning}</td>
          <td>${afternoon}</td>
          <td>${night}</td>
          <td>${qty}</td>
          <td>${mrp}</td>
          <td class="gstCol">${gst.toFixed(2)}</td>
          <td class="cgstCol">${cgst.toFixed(2)}</td>
          <td class="sgstCol">${sgst.toFixed(2)}</td>
          <td>${total.toFixed(2)}</td>
        </tr>`;
    });

    $("#billBody").html(billRows);
    $("#billTabletTotal").text(tabletTotal.toFixed(2));
    $("#billNet").text($("#net_amount").val());

    if (gstUsed) {
        $("#gstHead,#cgstHead,#sgstHead,.gstCol,.cgstCol,.sgstCol").show();
    } else {
        $("#gstHead,#cgstHead,#sgstHead,.gstCol,.cgstCol,.sgstCol").hide();
    }

    function showRow(row, span, val) {
        val = parseFloat(val) || 0;
        if (val > 0) {
            $("#" + span).text(val.toFixed(2));
            $("#" + row).removeClass("d-none");
        } else {
            $("#" + row).addClass("d-none");
        }
    }

    let tabletGrand = parseFloat($("#overalltablettotal").val()) || 0;
    let taxPercent = parseFloat($("#salestax_percent").val()) || 0;
    showRow("rowSalesTax", "billSalesTax", tabletGrand * taxPercent / 100);
    showRow("rowService", "billService", $("#service_charge").val());
    showRow("rowDelivery", "billDelivery", $("#delivery_charge").val());
    showRow("rowScan", "billScan", $("#scan_charge").val());
    showRow("rowCash", "billCash", $("#cash_paid").val());
    showRow("rowUpi", "billUpi", $("#gpay_paid").val());
    showRow("rowRemain", "billRemain", $("#remaining_amount").val());

    billModal.show();
}

// success: function(res){
//     generateBill();
// }

$("#printBillBtn").click(function () {
    let printContents = document.getElementById("printArea").innerHTML;
    let printWindow = window.open('', '', 'width=900,height=700');

    printWindow.document.write(`
        <html>
        <head>
            <title>Medical Bill</title>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
        </head>
        <body class="p-3">${printContents}</body>
        </html>
    `);

    printWindow.document.close();
    printWindow.onload = function () {
        printWindow.print();
        printWindow.close();
    };
    $("tbody").empty();
    $("input").val("");
});



    </script>
<!-- imporatant div -->
</div>